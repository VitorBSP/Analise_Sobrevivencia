---
title: "Lista 3"
output: html_document
date: '2022-07-01'
---

```{r, echo = F}
options(digits=3)  #Arrendodamento
options(scipen=999)
ggplot2::theme_set(ggplot2::theme_minimal()) #Tema dos gráficos produzidos no ggplot2
knitr::opts_chunk$set(echo=F,message=F,warning=F,fig.pos = 'H',fig.align = 'center',fig.width=7.8, fig.height=3.85)
scale_fill_discrete = \(...) ggplot2::scale_fill_brewer(... , palette="Set1") #Fixa a scale do fill dos gráficos do ggplot2
```


```{r, echo = F}
library(survival)
library(ggfortify)
library(dplyr)
library(magrittr)
library(patchwork)
```


```{r func}
banco <- function(vetor){
  vetor_ajustado = stringr::str_split(vetor, ", ") |> unlist()
  censura <- as.vector(stringr::str_detect(vetor_ajustado,"[+]") |> sapply(\(x) if(x == TRUE ) 0 else 1))
  vetor_ajustado <- gsub("[+]", "", vetor_ajustado) |> as.integer()
  df <- data.frame(tempos = vetor_ajustado, censura = censura)
}

grafico <- function(data, v1, title, v2 = tempo){
  ggplot(data) +
    geom_point(aes({{v2}},{{v1}})) +
    labs(title = title)
}

```


```{r}
df <- banco("6, 6, 6, 6+, 7, 9+, 10, 10+, 11+, 13, 16, 17+, 19+, 20+, 22, 23, 25+, 32+, 32+, 34+, 35+, 1, 1, 2, 2, 3, 4, 4, 5, 5, 8, 8, 8, 8, 11, 11, 12, 12, 15, 17, 22, 23")
df <- df |> mutate(grupo = rep(c("Droga","Placebo"), c(21,21)))

```

```{r}
fit_ekm <- survfit(Surv(tempos,censura)~grupo, data = df)
ekm <- fit_ekm$surv %>% 
  data.frame(sobrevivencia=.) %>% 
    mutate(grupo = rep(c("Droga","Placebo"), c(fit_ekm$strata)), tempo = fit_ekm$time) %>%
    mutate(grupo = factor(grupo))
autoplot(fit_ekm)
```

## Verificação da Linearização

Com as figuras que serão apresentadas nessa subseção verificaremos qual o modelo paramétrico mais adequado ao conjunto de dados do tempo de remissão da leucemia. Verificaremos qual gráfico possui os pontos que se traçassemos uma reta  mais se assemelharia com a bissetriz (y = x). Isto pois estamos verificando se a linearização do modelo paramétrico, condiz com uma linearização da sobrevivência estimada por Kaplan-Meier, assim o modelo com a linearização da sobrevivência estimada mais adequada, resultará em um melhor ajuste do modelo paramétrico. 

```{r placebo, fig.cap="Linearização do modelos paramétricos para o Placebo"}
grafico(ekm %>% filter(grupo == "Placebo"), -log(sobrevivencia), "Exponencial - Placebo")  +
grafico(ekm %>% filter(grupo == "Placebo"), log(-log(sobrevivencia)), 
         "Weibull - Placebo", log(tempo))  +
grafico(ekm %>% filter(grupo == "Placebo"), qnorm(sobrevivencia), 
         "Log-normal - Placebo", log(tempo))  
```
Nos gráficos da Figura \ref{@fig:placebo}, percebemos que o modelo Log-normal temos que os dados estão mais curvados, já nos modelos Exponencial e Weibull, temos os pontos distribuídos de formas mais semelhantes, no entanto o modelo Expoencial está com os pontos mais concentrados na parte inicial e na Weibull os pontos estão mais espalhados, assim parece ter uma menor variação em relação à bissetriz (y = x), assim o modelo com a linearização mais apropriada para o Placebo é o modelo Weibull.

```{r droga, fig.cap="Linearização do modelos paramétricos para o Droga 6MP"}
grafico(ekm %>% filter(grupo == "Droga"), -log(sobrevivencia), "Exponencial - Droga 6MP") +
grafico(ekm %>% filter(grupo == "Droga"), log(-log(sobrevivencia)), 
        "Weibull - Droga 6MP", log(tempo)) +
grafico(ekm %>% filter(grupo == "Droga"), -qnorm(sobrevivencia), 
        "Log-normal - Droga 6MP", log(tempo))
```
Nos gráficos da Figura \ref{@fig:droga}, percebemos que todos os modelos estão os pontos dispostos de formas semelhantes, com o mais diferente sendo o Modelo Exponencial, mas como todos os modelos são muito semelhantes, iremos ficar com o modelo escolhido no Placebo, o modelo exponencial. 


### Teste de Hipóteses

```{r}
fit_generalizado<-flexsurv::flexsurvreg(Surv(tempos,censura)~grupo, data = df,
                                        dist='gengamma')
fit_exp<-survreg(Surv(tempos,censura)~grupo, data=df, dist='exponential')
fit_weibull<-survreg(Surv(tempos,censura)~grupo, data=df, dist='weibull')
fit_lognorm<-survreg(Surv(tempos,censura)~grupo, data=df, dist='lognormal')
```

Usaremos o teste de razão de verossimilhanças em modelos encaixados e utilizaremos a Gama Generalizada como o modelo mais geral.

$$H_0:\text{O modelo testado é mais adequado que o modelo Generalizado.}$$
$$H_1:\text{O modelo testado não é mais adequado que o modelo Generalizado.}$$

Assim buscamos os modelos que não rejeitem a hipóteste $H_0$, assim para os modelos Exponencial, Weibull e Log-normal, temos os seguintes p-valores: `r 1-pchisq(2*(fit_generalizado$loglik[1]-fit_exp$loglik[1]),2)`, 
`r 1-pchisq(2*(fit_generalizado$loglik[1]-fit_weibull$loglik[1]),1)` e
`r 1-pchisq(2*(fit_generalizado$loglik[1]-fit_lognorm$loglik[1]),1)`, respectivamente, assim em todos temos evidências para a rejeição de $H_0$, logo nenhum é mais adequado que a Gama Generalizada. 

Utilizando o modelo Weibull como modelo generalizado e como modelo testado a Exponencial, temos que o p-valor é `r 1-pchisq(2*(fit_weibull$loglik[1]-fit_exp$loglik[1]),1) `, assim não rejeitamos a $H_0$ e reafirmamos o que foi analisado graficamente, que o modelo Exponencial é mais adequado que o modelo Weibull.

## Escolha do modelo adequado

Nessa subseção teremos que escolher o modelo mais adequado somente para o grupo da Droga 6MP, começaremos realizando o teste de hipóteses utilizado anteriormente, no entanto agora só com os dados do grupo com a utilização do remédio.


```{r}
df_droga = df %>% filter(grupo == "Droga")

fit_generalizado2<-flexsurv::flexsurvreg(Surv(tempos,censura)~1, data = df_droga,                                        dist='gengamma.orig')
fit_exp2<-survreg(Surv(tempos,censura)~1, data=df_droga, dist='exponential')
fit_weibull2<-survreg(Surv(tempos,censura)~1, data=df_droga, dist='weibull')
fit_lognorm2<-survreg(Surv(tempos,censura)~1, data=df_droga, dist='lognormal')
1-pchisq(2*(fit_generalizado2$loglik[1]-fit_exp2$loglik[1]),2)
1-pchisq(2*(fit_generalizado2$loglik[1]-fit_weibull2$loglik[1]),1)
1-pchisq(2*(fit_generalizado2$loglik[1]-fit_lognorm2$loglik[1]),1)
1-pchisq(2*(fit_weibull2$loglik[1]-fit_exp2$loglik[1]),1)
```


Considerando apenas os grupo da Droga 6MP, utilizando os modelos Exponencial, Weibull e Log-normal, temos os seguintes p-valores: `r 1-pchisq(2*(fit_generalizado2$loglik[1]-fit_exp2$loglik[1]),2)`, 
`r 1-pchisq(2*(fit_generalizado2$loglik[1]-fit_weibull2$loglik[1]),1)` e
`r 1-pchisq(2*(fit_generalizado2$loglik[1]-fit_lognorm2$loglik[1]),1)`, respectivamente, assim em todos não temos evidências para a rejeição de $H_0$, logo todos são mais adequados que a Gama Generalizada. 

Utilizando o modelo Weibull como modelo generalizado e como modelo testado a Exponencial, temos que o p-valor é `r 1-pchisq(2*(fit_weibull2$loglik[1]-fit_exp2$loglik[1]),1) `, assim também não rejeitamos a $H_0$ e temos que o modelo Exponencial é mais adequado que o modelo Weibull.

Assim, continuaremos a análise com os modelo exponencial, por ser o modelo mais simples.


### Análise de resíduo

```{r}
beta=fit_exp2$coefficients
# res�duo de Cox-Snell res�duo X KM_residuo+S_{exp1}(res)
# para o modelo Exponencial
res<- df_droga$tempo*exp(-t(rep(1, nrow(df_droga))) |> t()%*%(beta)) |> unlist()
# res=temp*exp((-X%*%(beta))^gammahat) Se modelo Weibull
# res=-log(1-pnorm((log(tempo)-X%*%(beta))/sigmahat)) Se modelo Log-normal
# Para outras distribui��es obter as express�es do lambdahat= -log Shat
ekm <- survfit(Surv(res,df_droga$censura)~1, type=c("kaplan-meier"))
par(mfrow=c(1,2))
plot(ekm, conf.int=F, lty=c(1,1), xlab="residuos", ylab="S(res) estimada")
res2<-sort(res)
exp1<-exp(-res2)
lines(res2, exp1, lty=3)
legend(0.8, 1.0, lty=c(1,3), c("Kaplan-Meier","Exponencial(1)"), lwd=1, bty="n", cex=0.8)

# KM_residuo X S_{exp1}(res)
st<-ekm$surv
t<-ekm$time
sexp1<-exp(-t)
plot(st, sexp1, xlab="S(res): Kaplan-Meier", ylab= "S(res): Exponencial(1)", pch=16)

# res�duo padronizado 
resp= log(temp)-X%*%(beta)
par(mfrow=c(1,1))
plot(df$)

#res�duo martingal para identifica��o da
# forma da covari�vel
m=cens-res

modelo=lm(m~lwbc)
plot(lwbc, m)
abline(lm(m~lwbc))

# res�duo Deviance
d=sign(-m)*sqrt(-2*(m+cens*log(cens-m)))
rd=resid(fit4, type="deviance")
plot(d)
plot(rd)

```




